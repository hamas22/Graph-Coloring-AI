<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Graph Colouring Solver</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseGlow { 0% { box-shadow: 0 0 15px rgba(8, 82, 90, 0.5); } 50% { box-shadow: 0 0 30px rgb(0, 104, 174); } 100% { box-shadow: 0 0 15px rgba(0, 173, 192, 0.5); } }
        @keyframes textStreamIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes nodeFloat {
            0% { transform: translate(0, 0) scale(1); opacity: 0.7; }
            25% { transform: translate(20px, 15px) scale(1.05); opacity: 0.8; }
            50% { transform: translate(-10px, 25px) scale(0.95); opacity: 0.6; }
            75% { transform: translate(15px, -5px) scale(1.1); opacity: 0.9; }
            100% { transform: translate(0, 0) scale(1); opacity: 0.7; }
        }
        @keyframes nodePulse {
            0%, 100% { box-shadow: 0 0 10px currentColor, 0 0 20px currentColor; }
            50% { box-shadow: 0 0 15px currentColor, 0 0 30px currentColor; }
        }

        :root {
            --color-bg: #0d1117;
            --color-primary: #00e7ff;
            --color-secondary: #0a1931;
            --color-glass: rgba(10, 25, 49, 0.6);
            --color-border: rgba(0, 231, 255, 0.2);
            --color-shadow: rgba(0, 231, 255, 0.1);
            --color-text: #e6f1ff;
            --color-text-dim: #a5c8ff;
            --color-node-1: #FF5733;
            --color-node-2: #33FF57;
            --color-node-3: #3357FF;
            --color-node-4: #FF33F7;
            --color-node-5: #F7FF33;
            --color-node-6: #33F7FF;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body 
        {
             font-family: 'Cairo', 'Segoe UI', sans-serif; 
             background-color: var(--color-bg); 
            background-image: url("../stars1.webp");
             background-attachment: fixed;
             color: var(--color-text); 
             display: flex;
               justify-content: center; align-items: flex-start; min-height: 100vh; padding: 40px 20px; overflow-y: auto; position: relative; overflow-x: hidden; }
        
        .background-nodes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: -1;
        }
        .background-node {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            opacity: 0.7;
            animation: nodeFloat 15s infinite ease-in-out alternate, nodePulse 4s infinite alternate;
        }
        .background-node:nth-child(1) { top: 10%; left: 15%; background-color: var(--color-node-1); animation-delay: 0s, 0.5s; }
        .background-node:nth-child(2) { top: 30%; left: 80%; background-color: var(--color-node-2); animation-delay: 2s, 1s; width: 60px; height: 60px; }
        .background-node:nth-child(3) { top: 60%; left: 20%; background-color: var(--color-node-3); animation-delay: 4s, 1.5s; width: 40px; height: 40px; }
        .background-node:nth-child(4) { top: 80%; left: 60%; background-color: var(--color-node-4); animation-delay: 6s, 2s; }
        .background-node:nth-child(5) { top: 5%; left: 50%; background-color: var(--color-node-5); animation-delay: 8s, 2.5s; width: 70px; height: 70px; }
        .background-node:nth-child(6) { top: 45%; left: 5%; background-color: var(--color-node-6); animation-delay: 10s, 3s; }
        .background-node:nth-child(7) { top: 20%; left: 40%; background-color: var(--color-node-1); animation-delay: 12s, 3.5s; width: 45px; height: 45px; }
        .background-node:nth-child(8) { top: 70%; left: 35%; background-color: var(--color-node-2); animation-delay: 14s, 4s; }


        .container { width: 100%; max-width: 550px; background: var(--color-glass); border: 1px solid var(--color-border); border-radius: 20px; padding: 30px; box-shadow: 0 8px 32px 0 var(--color-shadow); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); animation: fadeIn 0.8s ease-out forwards; margin-bottom: 50px; position: relative; z-index: 1; }
        h2 { text-align: center; color: var(--color-primary); text-shadow: 0 0 12px var(--color-primary); margin-bottom: 25px; font-weight: 700; }
        label { display: block; margin: 15px 0 5px; color: var(--color-text-dim); font-weight: 600; font-size: 0.9rem; }
        input[type="number"], select { width: 100%; padding: 12px 15px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 231, 255, 0.3); border-radius: 8px; color: var(--color-text); font-size: 1rem; font-family: 'Cairo', sans-serif; transition: all 0.3s ease; }
        input[type="number"]:focus, select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 15px var(--color-shadow); }
        select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2300e7ff' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659L8.753 11.14a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 15px center; padding-right: 40px; padding-left: 15px; }
        #edge-buttons { background: rgba(0, 0, 0, 0.2); border: 1px dashed var(--color-border); border-radius: 8px; padding: 10px; margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 8px; }
        #edge-buttons-label { color: var(--color-text-dim); margin-bottom: 5px; font-size: 0.9rem; }
        .edge-btn { display: inline-block; padding: 8px 10px; background: rgba(0, 231, 255, 0.1); color: var(--color-primary); border: 1px solid var(--color-border); border-radius: 5px; cursor: pointer; transition: all 0.2s ease; text-align: center; font-weight: 600; }
        .edge-btn:hover { background: rgba(0, 231, 255, 0.3); }
        .edge-btn.selected { background: var(--color-primary); color: var(--color-bg); text-shadow: none; box-shadow: 0 0 10px var(--color-primary); border-color: var(--color-primary); }
        #ca-params { background: rgba(0, 0, 0, 0.1); border-radius: 8px; margin-top: 0; padding: 0 15px 0 10px; overflow: hidden; max-height: 0; opacity: 0; border-left: 4px solid transparent; transition: all 0.5s ease-out; }
        #ca-params label { font-size: 0.85rem; }
        #ca-params input { padding: 10px; margin-bottom: 10px; }
        .action-button { width: 100%; padding: 15px; margin-top: 25px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; font-family: 'Cairo', sans-serif; cursor: pointer; background: var(--color-primary); color: var(--color-bg); box-shadow: 0 0 15px rgba(0, 231, 255, 0.5); transition: all 0.3s ease; transform: perspective(1px) translateZ(0); }
        .action-button:hover { background: #b4dfea; color: black; box-shadow: 0 0 20px #afb5b7; }
        .action-button:active { transform: scale(0.98); }
        h3 { color: var(--color-primary); text-shadow: 0 0 8px var(--color-primary); margin: 25px 0 10px; padding-bottom: 5px; border-bottom: 1px solid var(--color-border); }
        .result-box { background: rgba(0, 0, 0, 0.3); border-left: 4px solid var(--color-primary); padding: 15px 20px; border-radius: 0 8px 8px 0; font-size: 0.95rem; line-height: 1.8; min-height: 50px; display: flex; align-items: center; }
        .result-box .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0, 231, 255, 0.3); border-radius: 50%; border-top-color: var(--color-primary); animation: spin 1s ease-in-out infinite; margin-left: 10px; }
        .result-item { display: block; opacity: 0; animation: textStreamIn 0.5s ease-out forwards; }
        .result-item span { color: var(--color-text-dim); min-width: 140px; display: inline-block; }
        .result-item b { color: #fff; font-family: monospace; font-size: 1.1rem; }
        .graph-vis-container { text-align: center; margin-top: 20px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--color-border); border-radius: 15px; padding: 15px; min-height: 250px; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        .graph-vis-container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to right, rgba(0, 231, 255, 0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(0, 231, 255, 0.05) 1px, transparent 1px); background-size: 20px 20px; opacity: 0.5; }
        .graph-img { width: 100%; max-width: 450px; height: auto; border-radius: 10px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); transition: opacity 0.2s ease-in-out; opacity: 0; position: relative; z-index: 2; }
        .sim-controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        .sim-controls button { width: auto; padding: 10px 15px; margin-top: 0; font-size: 1rem; }
        #opt-button-container { text-align: center; margin-top: 25px; padding: 10px; border-top: 1px solid var(--color-border); display: none; }
        #opt-button { background: #DA42A2; color: var(--color-bg); box-shadow: 0 0 15px rgba(218, 66, 162, 0.5); }
        #opt-button:hover { background: #ff75d0; color: black; box-shadow: 0 0 20px rgba(218, 66, 162, 0.8); }
        .simulation-active .action-button, .simulation-active #opt-button { pointer-events: none; opacity: 0.5; }
        .simulation-paused .play-pause-btn { background: #ff5722; }
        .simulation-paused .play-pause-btn:hover { background: #ff8a65; color: black; }
        .secondary-section { border-top: 2px dashed var(--color-border); margin-top: 30px; padding-top: 20px; animation: fadeIn 0.8s ease-out forwards; }
        .secondary-section h3 { color: #DA42A2; text-shadow: 0 0 8px rgba(218, 66, 162, 0.5); border-color: rgba(218, 66, 162, 0.3); }
        .secondary-section .result-box { border-left-color: #DA42A2; }
        .secondary-section .graph-vis-container::before { background: linear-gradient(to right, rgba(218, 66, 162, 0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(218, 66, 162, 0.05) 1px, transparent 1px); }
    </style>
</head>

<body >

    <div class="background-nodes">
        <div class="background-node"></div>
        <div class="background-node"></div>
        <div class="background-node"></div>
        <div class="background-node"></div>
        <div class="background-node"></div>
        <div class="background-node"></div>
        <div class="background-node"></div>
        <div class="background-node"></div>
    </div>

    <div class="container">
        <h2>Graph Colouring Visualizer</h2>

        <label for="nodes">Number of Nodes:</label>
        <input type="number" id="nodes" min="2" max="10" value="3" onchange="updateEdges()">

        <label id="edge-buttons-label">Select Edges (Connect Nodes):</label>
        <div id="edge-buttons"></div>

        <label for="algorithm">Algorithm:</label>
        <select id="algorithm" onchange="toggleCAParams()">
            <option value="backtracking">Backtracking</option>
            <option value="cultural">Cultural Algorithm</option>
        </select>

        <label for="max_colors">Max Colors (M):</label>
        <input type="number" id="max_colors" value="4" min="1">

        <div id="ca-params">
            <label>Population Size:</label>
            <input type="number" id="pop_size" value="20">
            <label>Generations:</label>
            <input type="number" id="generations" value="50">
            <label>Mutation Rate:</label>
            <input type="number" id="mutation_rate" value="0.1" step="0.01" min="0" max="1">
        </div>

        <button class="action-button" onclick="solve('run')">Run Simulation & Visualize Steps</button>

        <div id="primary-run-section">
            <h3>Result:</h3>
            <div id="result-primary" class="result-box">
                Waiting for simulation to start...
            </div>

            <div id="graph-container-primary" class="graph-vis-container">
                <img id="graph_img_primary" class="graph-img" src="">
            </div>
            
            <div id="simulation-controls-primary" class="sim-controls" style="display: none;">
                <button id="play-pause-btn-primary" class="play-pause-btn" onclick="toggleSimulationPause()">革 Pause</button>
                <button onclick="stopSimulation()">癸 Stop</button>
                <input type="range" id="speed-slider" min="10" max="1000" value="200" style="flex-grow: 1;">
            </div>
        </div>
        
        <div id="opt-button-container">
            <p style="color: var(--color-text-dim); margin-bottom: 10px; font-size: 0.9rem;">
                Try a better approach?
            </p>
            <button id="opt-button" class="action-button" onclick="solve('backtracking_optimized')">
                 Run Optimized Backtracking (Heuristics)
            </button>
        </div>

        <div id="secondary-run-section" class="secondary-section" style="display: none;">
            <h3>Optimized Result:</h3>
            <div id="result-opt" class="result-box">
                Waiting for simulation...
            </div>

            <div id="graph-container-opt" class="graph-vis-container">
                <img id="graph_img_opt" class="graph-img" src="">
            </div>
            
            <div id="simulation-controls-opt" class="sim-controls" style="display: none;">
                <button id="play-pause-btn-opt" class="play-pause-btn" onclick="toggleSimulationPause()">革 Pause</button>
                <button onclick="stopSimulation()">癸 Stop</button>
            </div>
        </div>

    </div>

    <script>
        let selectedEdges = [];
        let simulationRunning = false;
        let simulationPaused = false;
        let currentStep = 0;
        let simulationData = null;
        let currentAlgorithm = null;
        let simulationTimeout = null;
        
        let isSecondaryRun = false;

        function updateEdges() {
            selectedEdges = [];
            document.getElementById('edge-buttons').innerHTML = '';
            generateEdgeButtons();
        }

        function generateEdgeButtons() {
            const n = parseInt(document.getElementById('nodes').value);
            let container = document.getElementById('edge-buttons');
            container.innerHTML = '';

            let allEdges = [];
            for (let i = 0; i < n; i++)
                for (let j = i + 1; j < n; j++)
                    allEdges.push(`${i}-${j}`);

            allEdges.forEach(e => {
                const btn = document.createElement('div');
                btn.className = 'edge-btn';
                btn.innerText = e;
                btn.onclick = (event) => toggleEdge(event, e);
                container.appendChild(btn);
            });

            const currentEdges = selectedEdges.slice();
            selectedEdges = [];
            document.querySelectorAll('.edge-btn').forEach(btn => {
                if (currentEdges.includes(btn.innerText)) {
                    btn.classList.add('selected');
                    selectedEdges.push(btn.innerText);
                }
            });
        }

        function toggleEdge(event, edge) {
            if (selectedEdges.includes(edge)) {
                selectedEdges = selectedEdges.filter(e => e !== edge);
                event.target.classList.remove('selected');
            } else {
                selectedEdges.push(edge);
                event.target.classList.add('selected');
            }
        }

        function toggleCAParams() {
            const algo = document.getElementById('algorithm').value;
            const paramsDiv = document.getElementById('ca-params');
            if (algo === 'cultural') {
                paramsDiv.style.maxHeight = '350px';
                paramsDiv.style.opacity = '1';
                paramsDiv.style.padding = '15px 15px 15px 10px';
                paramsDiv.style.marginTop = '10px';
                paramsDiv.style.borderLeft = '4px solid var(--color-primary)';
            } else {
                paramsDiv.style.maxHeight = '0';
                paramsDiv.style.opacity = '0';
                paramsDiv.style.padding = '0 15px 0 10px';
                paramsDiv.style.marginTop = '0';
                paramsDiv.style.borderLeft = '4px solid transparent';
            }
        }
        
        function getUIElements() {
            if (isSecondaryRun) {
                return {
                    resultDiv: document.getElementById('result-opt'),
                    imgElement: document.getElementById('graph_img_opt'),
                    controlsDiv: document.getElementById('simulation-controls-opt'),
                    playPauseBtn: document.getElementById('play-pause-btn-opt')
                };
            } else {
                return {
                    resultDiv: document.getElementById('result-primary'),
                    imgElement: document.getElementById('graph_img_primary'),
                    controlsDiv: document.getElementById('simulation-controls-primary'),
                    playPauseBtn: document.getElementById('play-pause-btn-primary')
                };
            }
        }

        async function solve(mode) {
            stopSimulation();
            
            let algorithm = document.getElementById('algorithm').value;
            
            if (mode === 'backtracking_optimized') {
                isSecondaryRun = true;
                algorithm = 'backtracking_optimized';
                document.getElementById('secondary-run-section').style.display = 'block';
            } else {
                isSecondaryRun = false;
                currentAlgorithm = algorithm;
                document.getElementById('secondary-run-section').style.display = 'none';
                document.getElementById('opt-button-container').style.display = 'none';
            }
            
            const ui = getUIElements();
            
            const n = parseInt(document.getElementById('nodes').value);
            const edges = selectedEdges.map(e => e.split('-').map(Number));
            const max_colors = parseInt(document.getElementById('max_colors').value);

            const pop_size = parseInt(document.getElementById('pop_size').value);
            const generations = parseInt(document.getElementById('generations').value);
            const mutation_rate = parseFloat(document.getElementById('mutation_rate').value);

            if (edges.length === 0) {
                alert("锔 Please select at least one edge!");
                return;
            }

            ui.resultDiv.innerHTML = `Processing ${algorithm.replace('_', ' ')}... <span class="spinner"></span>`;
            ui.imgElement.style.opacity = 0.3;
            document.body.classList.add('simulation-active');

            try {
                const res = await axios.post('/simulate', {
                    nodes: n,
                    edges: edges,
                    algorithm: algorithm,
                    max_colours: max_colors,
                    pop_size: pop_size,
                    generations: generations,
                    mutation_rate: mutation_rate
                });

                simulationData = res.data;
                currentStep = 0;
                simulationRunning = true;
                simulationPaused = false;
                
                ui.controlsDiv.style.display = 'flex';
                ui.playPauseBtn.innerText = '革 Pause';
                document.body.classList.remove('simulation-paused');

                runSimulationLoop();

            } catch (error) {
                console.error("Error during simulation:", error);
                ui.resultDiv.innerHTML = "锔 An error occurred during simulation.";
                ui.imgElement.style.opacity = 1;
                stopSimulation();
            }
        }
        
        async function runSimulationLoop() {
            if (!simulationRunning) return;

            if (simulationPaused) {
                simulationTimeout = setTimeout(runSimulationLoop, 100);
                return;
            }

            if (currentStep < simulationData.steps.length) {
                await visualizeStep(simulationData.steps[currentStep]);
                currentStep++;

                const speedSlider = document.getElementById('speed-slider');
                let delay = parseInt(speedSlider.max) + parseInt(speedSlider.min) - parseInt(speedSlider.value);

                simulationTimeout = setTimeout(runSimulationLoop, delay);
            } else {
                simulationRunning = false;
                displayFinalResult(simulationData);
                document.body.classList.remove('simulation-active');
                
                const ui = getUIElements();
                ui.controlsDiv.style.display = 'none';
                
                if (!isSecondaryRun && currentAlgorithm === 'backtracking' && simulationData.chromatic_number > 0) {
                    document.getElementById('opt-button-container').style.display = 'block';
                }
            }
        }
        
        function toggleSimulationPause() {
            simulationPaused = !simulationPaused;
            const ui = getUIElements();
            
            if (simulationPaused) {
                ui.playPauseBtn.innerText = '讹 Play';
                document.body.classList.add('simulation-paused');
            } else {
                ui.playPauseBtn.innerText = '革 Pause';
                document.body.classList.remove('simulation-paused');
            }
        }

        function stopSimulation() {
            if (simulationTimeout !== null) {
                clearTimeout(simulationTimeout);
            }
            simulationTimeout = null;
            simulationRunning = false;
            simulationPaused = false;
            currentStep = 0;
            simulationData = null;
            
            const ui = getUIElements();
            if(ui.controlsDiv) ui.controlsDiv.style.display = 'none';
            
            document.body.classList.remove('simulation-active');
            document.body.classList.remove('simulation-paused');
        }
        
        async function visualizeStep(step_data) {
            const n = parseInt(document.getElementById('nodes').value);
            const edges = selectedEdges.map(e => e.split('-').map(Number));
            const ui = getUIElements();
            
            let coloring = step_data;
            let domains = null;

            if (Array.isArray(step_data) && step_data.length === 2 && Array.isArray(step_data[0])) {
                coloring = step_data[0];
                domains = step_data[1];
            } 
            
            try {
                const stepRes = await axios.post('/step_image', { 
                    nodes: n, 
                    edges: edges, 
                    coloring: coloring, 
                    node_domains: domains 
                });

                return new Promise((resolve) => {
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        ui.imgElement.src = tempImg.src;
                        ui.imgElement.style.opacity = 1;
                        resolve();
                    };
                    tempImg.src = "data:image/png;base64," + stepRes.data.image;
                });

            } catch (err) {
                console.error("Step visualization failed", err);
            }
        }

        function displayFinalResult(data) {
            const ui = getUIElements();
            ui.resultDiv.innerHTML = `
                <div style="width: 100%;">
                    <span class="result-item" style="animation-delay: 0s;"><span>З Final Solution:</span> <b>[${data.solution.join(', ')}]</b></span>
                    <span class="result-item" style="animation-delay: 0.2s;"><span> Conflicts:</span> <b>${data.conflicts}</b></span>
                    <span class="result-item" style="animation-delay: 0.4s;"><span> Chromatic Number:</span> <b>${data.chromatic_number}</b></span>
                    <span class="result-item" style="animation-delay: 0.6s;"><span>憋 Time Taken:</span> <b>${data.time.toFixed(4)} sec</b></span>
                </div>
            `;
            
            const n = parseInt(document.getElementById('nodes').value);
            const edges = selectedEdges.map(e => e.split('-').map(Number));
            
            axios.post('/step_image', { 
                nodes: n, 
                edges: edges, 
                coloring: data.solution,
                node_domains: null
            }).then(finalStepRes => {
                const tempImg = new Image();
                tempImg.onload = () => {
                    ui.imgElement.src = tempImg.src;
                    ui.imgElement.style.opacity = 1;
                };
                tempImg.src = "data:image/png;base64," + finalStepRes.data.image;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateEdges();
            toggleCAParams();
        });
    </script>

</body>
</html>